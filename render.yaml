# Render.com Infrastructure as Code
# This file defines all services for the IronScout.ai application
#
# Database is managed in the Render dashboard (not in this Blueprint)
# Redis must be created manually in Render dashboard
# Redis cannot be defined in Blueprint files - see DEPLOYMENT.md for instructions

# --------------------------------------------------------------------------
# Environment Variable Groups
# --------------------------------------------------------------------------
envVarGroups:
  - name: ironscout-common
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: 25.5.0
      - key: PNPM_VERSION
        value: 10.28.1

  - name: ironscout-urls
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: https://api.ironscout.ai
      - key: NEXT_PUBLIC_APP_URL
        value: https://app.ironscout.ai
      - key: NEXT_PUBLIC_MERCHANT_URL
        value: https://merchant.ironscout.ai
      - key: NEXT_PUBLIC_WEB_URL
        value: https://ironscout.ai
      - key: NEXT_PUBLIC_WWW_URL
        value: https://www.ironscout.ai
      - key: ADMIN_PORTAL_URL
        value: https://admin.ironscout.ai
      - key: FRONTEND_URL
        value: https://www.ironscout.ai

  - name: ironscout-email
    envVars:
      - key: MERCHANT_EMAIL_FROM
        value: IronScout <noreply@ironscout.ai>
      - key: OPERATIONS_EMAIL_TO
        value: IronScout <noreply@ironscout.ai>

  - name: ironscout-secrets
    envVars:
      - key: NEXTAUTH_SECRET
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: ADMIN_EMAILS
        sync: false

  - name: ironscout-redis
    envVars:
      - key: REDIS_URL
        value: ""  # Set in dashboard - copy "Internal Key Value URL" from Redis instance

  - name: ironscout-stripe
    envVars:
      - key: STRIPE_SECRET_KEY
        value: ""  # Set in dashboard
      - key: STRIPE_WEBHOOK_SECRET
        value: ""  # Set in dashboard
      - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        value: ""  # Set in dashboard

  - name: ironscout-google
    envVars:
      - key: GOOGLE_CLIENT_ID
        value: ""  # Set in dashboard
      - key: GOOGLE_CLIENT_SECRET
        value: ""  # Set in dashboard

  - name: ironscout-slack
    envVars:
      - key: SLACK_DATAFEED_ALERTS_WEBHOOK_URL
        value: ""  # Set in dashboard

  - name: ironscout-openai
    envVars:
      - key: OPENAI_API_KEY
        value: ""  # Set in dashboard

  - name: ironscout-database
    envVars:
      - key: DATABASE_URL
        value: ""  # Set in dashboard - copy "Internal Database URL" from PostgreSQL instance

services:
  # --------------------------------------------------------------------------
  # API Backend Service
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-api
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/api type-check
    startCommand: cd apps/api && pnpm start
    healthCheckPath: /health
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-database
      - fromGroup: ironscout-redis
      - fromGroup: ironscout-stripe
      - fromGroup: ironscout-slack
      - fromGroup: ironscout-openai
      - fromGroup: ironscout-email
      - key: PORT
        value: 8000

  # --------------------------------------------------------------------------
  # Next.js Web Frontend
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-web
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/web build
    startCommand: cd apps/web && pnpm start
    healthCheckPath: /
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-stripe
      - fromGroup: ironscout-google
      - key: NEXTAUTH_URL
        value: https://ironscout.ai
      - key: AUTH_TRUST_HOST
        value: true
      - key: COOKIE_DOMAIN
        value: .ironscout.ai

  # --------------------------------------------------------------------------
  # Merchant Portal (B2B retailer interface)
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-merchant
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/crypto build && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/merchant build
    startCommand: cd apps/merchant && pnpm start
    healthCheckPath: /
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-database
      - fromGroup: ironscout-email
      - fromGroup: ironscout-redis

  # --------------------------------------------------------------------------
  # Admin Portal (internal administration)
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-admin
    runtime: node
    region: ohio
    plan: free
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/crypto build && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/admin build
    startCommand: cd apps/admin && pnpm start
    healthCheckPath: /
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-database
      - fromGroup: ironscout-email

  # --------------------------------------------------------------------------
  # Marketing Site (static) - www.ironscout.ai
  # --------------------------------------------------------------------------
  - type: web
    name: ironscout-www
    runtime: static
    buildCommand: pnpm install && pnpm --filter @ironscout/www build
    staticPublishPath: apps/www/out
    envVars:
      - fromGroup: ironscout-common
      - key: SKIP_INSTALL_DEPS
        value: true
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
    # NOTE: No rewrite rule - Next.js static export generates proper index.html files for each route

  # --------------------------------------------------------------------------
  # Harvester Worker (background ingestion â€” requires paid plan)
  # --------------------------------------------------------------------------
  - type: worker
    name: ironscout-harvester
    runtime: node
    region: ohio
    plan: starter  # Workers require paid plan
    buildCommand: pnpm install && pnpm --filter @ironscout/db db:generate && pnpm --filter @ironscout/notifications build && pnpm --filter @ironscout/harvester build
    startCommand: cd apps/harvester && pnpm worker
    envVars:
      - fromGroup: ironscout-common
      - fromGroup: ironscout-urls
      - fromGroup: ironscout-secrets
      - fromGroup: ironscout-database
      - fromGroup: ironscout-redis
      - fromGroup: ironscout-slack
      - fromGroup: ironscout-email

generator client {
  provider        = "prisma-client-js"
  output          = "./generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model admin_audit_logs {
  id          String   @id
  adminUserId String
  dealerId    String?
  action      String
  resource    String?
  resourceId  String?
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([adminUserId])
  @@index([createdAt])
  @@index([dealerId])
}

model advertisements {
  id          String   @id
  title       String
  description String
  imageUrl    String?
  targetUrl   String
  adType      AdType   @default(DISPLAY)
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model affiliate_feed_run_errors {
  id                  String              @id
  runId               String
  code                String
  message             String
  rowNumber           Int?
  sample              Json?
  createdAt           DateTime            @default(now())
  affiliate_feed_runs affiliate_feed_runs @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}

model affiliate_feed_runs {
  id                        String                      @id
  feedId                    String
  sourceId                  String
  trigger                   AffiliateFeedRunTrigger     @default(SCHEDULED)
  status                    AffiliateFeedRunStatus      @default(RUNNING)
  startedAt                 DateTime                    @default(now())
  finishedAt                DateTime?
  durationMs                Int?
  downloadBytes             BigInt?
  rowsRead                  Int?
  rowsParsed                Int?
  productsUpserted          Int?
  pricesWritten             Int?
  productsPromoted          Int?
  errorCount                Int?
  productsExpired           Int?
  productsRejected          Int?
  duplicateKeyCount         Int?
  urlHashFallbackCount      Int?
  activeCountBefore         Int?
  seenSuccessCount          Int?
  wouldExpireCount          Int?
  skippedReason             String?
  failureKind               String?
  failureCode               String?
  failureMessage            String?
  isPartial                 Boolean                     @default(false)
  expiryStepFailed          Boolean                     @default(false)
  expiryBlocked             Boolean                     @default(false)
  expiryBlockedReason       String?
  expiryApprovedAt          DateTime?
  expiryApprovedBy          String?
  artifactUrl               String?
  correlationId             String?
  affiliate_feed_run_errors affiliate_feed_run_errors[]
  affiliate_feeds           affiliate_feeds             @relation(fields: [feedId], references: [id], onDelete: Cascade)
  prices                    prices[]
  source_product_seen       source_product_seen[]

  @@index([feedId, startedAt])
  @@index([feedId, status, startedAt])
  @@index([feedId, trigger, startedAt])
}

model affiliate_feeds {
  id                     String                @id
  sourceId               String                @unique
  network                AffiliateNetwork
  status                 AffiliateFeedStatus   @default(DRAFT)
  scheduleFrequencyHours Int?
  nextRunAt              DateTime?
  expiryHours            Int                   @default(48)
  consecutiveFailures    Int                   @default(0)
  lastRunAt              DateTime?
  manualRunPending       Boolean               @default(false)
  transport              FeedTransport         @default(SFTP)
  host                   String?
  port                   Int?
  path                   String?
  username               String?
  secretCiphertext       Bytes?
  secretKeyId            String?
  secretVersion          Int                   @default(1)
  format                 FeedFormat            @default(CSV)
  compression            FeedCompression       @default(NONE)
  lastRemoteMtime        DateTime?
  lastRemoteSize         BigInt?
  lastContentHash        String?
  maxFileSizeBytes       BigInt?
  maxRowCount            Int?
  feedLockId             BigInt                @unique @default(autoincrement())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  createdBy              String?
  affiliate_feed_runs    affiliate_feed_runs[]
  sources                sources               @relation(fields: [sourceId], references: [id])

  @@index([nextRunAt])
  @@index([status])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model alerts {
  id              String           @id
  userId          String
  productId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  watchlistItemId String?
  ruleType        AlertRuleType?
  isEnabled       Boolean          @default(true)
  products        products         @relation(fields: [productId], references: [id], onDelete: Cascade)
  users           users            @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchlist_items watchlist_items? @relation(fields: [watchlistItemId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, ruleType], map: "alerts_userid_productid_ruletype_key")
  @@index([productId])
  @@index([userId])
  @@index([watchlistItemId])
}

model benchmarks {
  id             String              @id
  canonicalSkuId String              @unique
  medianPrice    Decimal             @db.Decimal(10, 2)
  minPrice       Decimal             @db.Decimal(10, 2)
  maxPrice       Decimal             @db.Decimal(10, 2)
  avgPrice       Decimal?            @db.Decimal(10, 2)
  sellerCount    Int
  source         BenchmarkSource
  confidence     BenchmarkConfidence
  dataPoints     Int                 @default(0)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime
  canonical_skus canonical_skus      @relation(fields: [canonicalSkuId], references: [id], onDelete: Cascade)
}

model canonical_skus {
  id                  String                @id
  upc                 String?               @unique
  caliber             String
  grain               Int
  caseType            String?
  bulletType          String?
  brand               String
  packSize            Int
  name                String
  imageUrl            String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  productId           String?
  benchmarks          benchmarks?
  products            products?             @relation(fields: [productId], references: [id])
  dealer_skus         dealer_skus[]
  pricing_snapshots   pricing_snapshots[]
  product_suggestions product_suggestions[]

  @@index([caliber, grain, brand, packSize])
  @@index([upc])
}

model click_events {
  id             String   @id
  dealerId       String
  dealerSkuId    String?
  canonicalSkuId String?
  sessionId      String?
  userAgent      String?
  ipHash         String?
  referrer       String?
  createdAt      DateTime @default(now())
  dealers        dealers  @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([dealerId])
  @@index([dealerSkuId])
  @@index([sessionId])
}

model data_subscriptions {
  id        String             @id
  userId    String
  plan      DaaSPlan           @default(BASIC)
  status    SubscriptionStatus @default(ACTIVE)
  apiKey    String             @unique
  rateLimit Int                @default(1000)
  createdAt DateTime           @default(now())
  updatedAt DateTime
  users     users              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model dealer_contacts {
  id                 String              @id
  dealerId           String
  firstName          String
  lastName           String
  email              String
  phone              String?
  marketingOptIn     Boolean             @default(false)
  communicationOptIn Boolean             @default(true)
  isAccountOwner     Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  roles              DealerContactRole[] @default([])
  dealers            dealers             @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@unique([dealerId, email])
  @@index([dealerId])
  @@index([email])
}

model dealer_feed_runs {
  id               String        @id
  dealerId         String
  feedId           String
  status           FeedRunStatus
  errors           Json?
  rowCount         Int           @default(0)
  duration         Int?
  startedAt        DateTime      @default(now())
  completedAt      DateTime?
  primaryErrorCode String?
  quarantinedCount Int           @default(0)
  coercionCount    Int           @default(0)
  errorCodes       Json?
  indexedCount     Int           @default(0)
  rejectedCount    Int           @default(0)
  matchedCount     Int           @default(0)
  dealer_feeds     dealer_feeds  @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([feedId])
  @@index([startedAt])
}

model dealer_feed_test_runs {
  id               String        @id
  dealerId         String
  feedId           String
  sampleSize       Int           @default(50)
  status           TestRunStatus
  recordsParsed    Int           @default(0)
  wouldIndex       Int           @default(0)
  wouldQuarantine  Int           @default(0)
  wouldReject      Int           @default(0)
  warningCount     Int           @default(0)
  errorCount       Int           @default(0)
  primaryErrorCode String?
  errorSamples     Json?
  coercionSummary  Json?
  duration         Int?
  startedAt        DateTime      @default(now())
  completedAt      DateTime?
  dealer_feeds     dealer_feeds  @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([feedId])
  @@index([startedAt])
}

model dealer_feeds {
  id                    String                  @id
  dealerId              String
  name                  String?
  url                   String?
  username              String?
  password              String?
  scheduleMinutes       Int                     @default(60)
  status                FeedStatus              @default(PENDING)
  feedHash              String?
  lastSuccessAt         DateTime?
  lastFailureAt         DateTime?
  lastError             String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  accessType            FeedAccessType          @default(URL)
  enabled               Boolean                 @default(true)
  formatType            FeedFormatType          @default(GENERIC)
  lastRunAt             DateTime?
  primaryErrorCode      String?
  dealer_feed_runs      dealer_feed_runs[]
  dealer_feed_test_runs dealer_feed_test_runs[]
  dealers               dealers                 @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealer_skus           dealer_skus[]
  feed_corrections      feed_corrections[]
  quarantined_records   quarantined_records[]

  @@index([dealerId])
  @@index([enabled])
}

model dealer_insights {
  id             String            @id
  dealerId       String
  dealerSkuId    String?
  canonicalSkuId String?
  type           InsightType
  confidence     InsightConfidence
  title          String
  message        String
  dealerPrice    Decimal?          @db.Decimal(10, 2)
  marketMedian   Decimal?          @db.Decimal(10, 2)
  marketMin      Decimal?          @db.Decimal(10, 2)
  marketMax      Decimal?          @db.Decimal(10, 2)
  sellerCount    Int?
  priceDelta     Decimal?          @db.Decimal(10, 2)
  deltaPercent   Decimal?          @db.Decimal(5, 2)
  metadata       Json?
  isActive       Boolean           @default(true)
  dismissedAt    DateTime?
  dismissedUntil DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime
  dealers        dealers           @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealer_skus    dealer_skus?      @relation(fields: [dealerSkuId], references: [id])

  @@index([dealerId])
  @@index([isActive])
  @@index([type])
}

model dealer_invites {
  id           String         @id
  dealerId     String
  email        String
  role         DealerUserRole @default(MEMBER)
  inviteToken  String         @unique
  invitedById  String
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime       @default(now())
  dealers      dealers        @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealer_users dealer_users   @relation(fields: [invitedById], references: [id])

  @@unique([dealerId, email])
  @@index([dealerId])
  @@index([inviteToken])
}

model dealer_notification_prefs {
  id                 String   @id
  dealerId           String   @unique
  fatalFeedErrors    Boolean  @default(true)
  nonFatalFeedIssues Boolean  @default(false)
  successfulUpdates  Boolean  @default(false)
  weeklyPulse        Boolean  @default(true)
  insightAlerts      Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  dealers            dealers  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
}

model dealer_skus {
  id                  String                @id
  dealerId            String
  feedId              String?
  feedRunId           String?
  rawTitle            String
  rawDescription      String?
  rawPrice            Decimal               @db.Decimal(10, 2)
  rawUpc              String?
  rawSku              String?
  rawCaliber          String?
  rawGrain            String?
  rawCase             String?
  rawBulletType       String?
  rawBrand            String?
  rawPackSize         Int?
  rawInStock          Boolean               @default(true)
  rawUrl              String?
  rawImageUrl         String?
  canonicalSkuId      String?
  mappingConfidence   MappingConfidence     @default(NONE)
  needsReview         Boolean               @default(false)
  mappedAt            DateTime?
  mappedBy            String?
  parsedCaliber       String?
  parsedGrain         Int?
  parsedPackSize      Int?
  parsedBulletType    String?
  parsedBrand         String?
  parseConfidence     Decimal?              @db.Decimal(3, 2)
  dealerSkuHash       String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  lastSeenAt          DateTime?
  missingCount        Int                   @default(0)
  productType         String?
  coercionsApplied    Json?
  dealer_insights     dealer_insights[]
  canonical_skus      canonical_skus?       @relation(fields: [canonicalSkuId], references: [id])
  dealers             dealers               @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealer_feeds        dealer_feeds?         @relation(fields: [feedId], references: [id])
  product_suggestions product_suggestions[]

  @@unique([dealerId, dealerSkuHash])
  @@index([canonicalSkuId])
  @@index([dealerId])
  @@index([feedId])
  @@index([isActive])
  @@index([needsReview])
}

model dealer_users {
  id             String           @id
  dealerId       String
  email          String
  passwordHash   String
  name           String
  role           DealerUserRole   @default(MEMBER)
  emailVerified  Boolean          @default(false)
  verifyToken    String?
  resetToken     String?
  resetTokenExp  DateTime?
  lastLoginAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  dealer_invites dealer_invites[]
  dealers        dealers          @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@unique([dealerId, email])
  @@index([dealerId])
  @@index([email])
}

model dealers {
  id                        String                     @id
  businessName              String
  websiteUrl                String
  phone                     String?
  storeType                 StoreType                  @default(ONLINE_ONLY)
  status                    DealerStatus               @default(PENDING)
  tier                      DealerTier                 @default(FOUNDING)
  pixelApiKey               String?                    @unique
  pixelEnabled              Boolean                    @default(false)
  shippingType              ShippingType               @default(UNKNOWN)
  shippingFlat              Decimal?                   @db.Decimal(10, 2)
  shippingPerUnit           Decimal?                   @db.Decimal(10, 2)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime
  retailerId                String?                    @unique
  contactFirstName          String
  contactLastName           String
  lastSubscriptionNotifyAt  DateTime?
  subscriptionExpiresAt     DateTime?
  subscriptionGraceDays     Int                        @default(7)
  subscriptionStatus        DealerSubscriptionStatus   @default(ACTIVE)
  autoRenew                 Boolean                    @default(true)
  paymentMethod             DealerPaymentMethod?
  stripeCustomerId          String?                    @unique
  stripeSubscriptionId      String?                    @unique
  click_events              click_events[]
  dealer_contacts           dealer_contacts[]
  dealer_feeds              dealer_feeds[]
  dealer_insights           dealer_insights[]
  dealer_invites            dealer_invites[]
  dealer_notification_prefs dealer_notification_prefs?
  dealer_skus               dealer_skus[]
  dealer_users              dealer_users[]
  retailers                 retailers?                 @relation(fields: [retailerId], references: [id])
  pixel_events              pixel_events[]
  product_suggestions       product_suggestions[]
}

model execution_logs {
  id          String     @id
  executionId String
  level       LogLevel   @default(INFO)
  event       String
  message     String
  metadata    Json?
  timestamp   DateTime   @default(now())
  executions  executions @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([event])
  @@index([executionId])
  @@index([level])
}

model executions {
  id             String           @id
  sourceId       String
  status         ExecutionStatus  @default(PENDING)
  startedAt      DateTime         @default(now())
  completedAt    DateTime?
  duration       Int?
  itemsFound     Int              @default(0)
  itemsUpserted  Int              @default(0)
  errorMessage   String?
  execution_logs execution_logs[]
  sources        sources          @relation(fields: [sourceId], references: [id], onDelete: Cascade)
}

model feed_corrections {
  id                  String               @id
  dealerId            String
  feedId              String
  quarantinedRecordId String?
  recordRef           String
  field               String
  oldValue            String?
  newValue            String
  createdBy           String
  createdAt           DateTime             @default(now())
  dealer_feeds        dealer_feeds         @relation(fields: [feedId], references: [id], onDelete: Cascade)
  quarantined_records quarantined_records? @relation(fields: [quarantinedRecordId], references: [id])

  @@index([dealerId])
  @@index([feedId, recordRef])
  @@index([quarantinedRecordId])
}

model market_reports {
  id          String   @id
  productId   String?
  category    String
  reportType  String
  data        Json
  generatedAt DateTime @default(now())
}

model pixel_events {
  id            String    @id
  dealerId      String
  orderId       String
  orderValue    Decimal   @db.Decimal(10, 2)
  orderCurrency String    @default("USD")
  skuList       Json?
  clickEventId  String?
  attributedAt  DateTime?
  userAgent     String?
  ipHash        String?
  referrer      String?
  createdAt     DateTime  @default(now())
  dealers       dealers   @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([dealerId])
  @@index([orderId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model prices {
  id                  String               @id
  productId           String?
  retailerId          String
  price               Decimal              @db.Decimal(10, 2)
  currency            String               @default("USD")
  url                 String
  inStock             Boolean              @default(true)
  createdAt           DateTime             @default(now())
  freeShippingMinimum Decimal?             @db.Decimal(10, 2)
  shippingCost        Decimal?             @db.Decimal(10, 2)
  shippingNotes       String?
  originalPrice       Decimal?             @db.Decimal(10, 2)
  priceType           PriceType?
  saleStartsAt        DateTime?
  saleEndsAt          DateTime?
  affiliateFeedRunId  String?
  priceSignatureHash  String?
  sourceProductId     String?
  affiliate_feed_runs affiliate_feed_runs? @relation(fields: [affiliateFeedRunId], references: [id])
  products            products?            @relation(fields: [productId], references: [id], onDelete: Cascade)
  retailers           retailers            @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  source_products     source_products?     @relation(fields: [sourceProductId], references: [id])
  product_reports     product_reports[]

  @@index([inStock])
  @@index([productId])
  @@index([retailerId])
  @@index([sourceProductId])
}

model pricing_snapshots {
  id             String         @id
  canonicalSkuId String
  dealerId       String
  price          Decimal        @db.Decimal(10, 2)
  pricePerRound  Decimal?       @db.Decimal(10, 4)
  packSize       Int
  inStock        Boolean        @default(true)
  createdAt      DateTime       @default(now())
  canonical_skus canonical_skus @relation(fields: [canonicalSkuId], references: [id], onDelete: Cascade)

  @@index([canonicalSkuId])
  @@index([createdAt])
  @@index([dealerId])
}

model product_reports {
  id          String           @id
  productId   String
  userId      String?
  priceId     String?
  issueType   ProductIssueType
  description String
  status      ReportStatus     @default(PENDING)
  reviewedBy  String?
  reviewNotes String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime
  resolvedAt  DateTime?
  prices      prices?          @relation(fields: [priceId], references: [id])
  products    products         @relation(fields: [productId], references: [id], onDelete: Cascade)
  users       users?           @relation(fields: [userId], references: [id])
}

model product_suggestions {
  id             String                  @id
  dealerId       String
  dealerSkuId    String?
  status         ProductSuggestionStatus @default(PENDING)
  suggestedName  String
  suggestedUpc   String?
  caliber        String
  grain          Int?
  packSize       Int?
  brand          String?
  bulletType     String?
  caseType       String?
  resolvedAt     DateTime?
  resolvedBy     String?
  rejectionNote  String?
  canonicalSkuId String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime
  canonical_skus canonical_skus?         @relation(fields: [canonicalSkuId], references: [id])
  dealers        dealers                 @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  dealer_skus    dealer_skus?            @relation(fields: [dealerSkuId], references: [id])

  @@index([createdAt])
  @@index([dealerId])
  @@index([status])
}

model products {
  id                    String                 @id
  name                  String
  description           String?
  category              String
  brand                 String?
  imageUrl              String?
  upc                   String?                @unique
  caliber               String?
  grainWeight           Int?
  caseMaterial          String?
  purpose               String?
  roundCount            Int?
  metadata              Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime
  embedding             Unsupported("vector")?
  barrelLengthReference Decimal?               @db.Decimal(4, 2)
  bulletType            BulletType?
  controlledExpansion   Boolean?
  dataConfidence        Decimal?               @db.Decimal(3, 2)
  dataSource            DataSource?            @default(UNKNOWN)
  factoryNew            Boolean?               @default(true)
  isSubsonic            Boolean?
  lowFlash              Boolean?
  lowRecoil             Boolean?
  matchGrade            Boolean?
  muzzleVelocityFps     Int?
  pressureRating        PressureRating?        @default(STANDARD)
  shortBarrelOptimized  Boolean?
  suppressorSafe        Boolean?
  alerts                alerts[]
  canonical_skus        canonical_skus[]
  prices                prices[]
  product_reports       product_reports[]
  watchlist_items       watchlist_items[]

  @@index([bulletType])
  @@index([caliber])
  @@index([isSubsonic])
  @@index([pressureRating])
  @@index([purpose])
}

model quarantined_records {
  id               String             @id
  dealerId         String
  feedId           String
  runId            String?
  productType      String?
  matchKey         String
  rawData          Json
  parsedFields     Json?
  blockingErrors   Json
  status           QuarantineStatus   @default(QUARANTINED)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  feed_corrections feed_corrections[]
  dealer_feeds     dealer_feeds       @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@unique([feedId, matchKey])
  @@index([dealerId])
  @@index([feedId, status])
  @@index([status])
}

model retailers {
  id            String          @id
  name          String
  website       String          @unique
  logoUrl       String?
  tier          RetailerTier    @default(STANDARD)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  dealers       dealers?
  prices        prices[]
  sources       sources[]
  subscriptions subscriptions[]
}

model source_product_presence {
  id                String          @id
  sourceProductId   String          @unique
  lastSeenAt        DateTime
  lastSeenSuccessAt DateTime?
  updatedAt         DateTime
  source_products   source_products @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@index([lastSeenSuccessAt])
}

model source_product_seen {
  id                  String              @id
  runId               String
  sourceProductId     String
  createdAt           DateTime            @default(now())
  affiliate_feed_runs affiliate_feed_runs @relation(fields: [runId], references: [id], onDelete: Cascade)
  source_products     source_products     @relation(fields: [sourceProductId], references: [id], onDelete: Cascade)

  @@unique([runId, sourceProductId])
  @@index([runId])
}

model source_products {
  id                      String                    @id
  sourceId                String
  identityType            SourceProductIdentityType
  identityValue           String
  title                   String
  url                     String
  imageUrl                String?
  sku                     String?
  upc                     String?
  urlHash                 String?
  normalizedUrl           String?
  impactItemId            String?
  createdByRunId          String?
  lastUpdatedByRunId      String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  prices                  prices[]
  source_product_presence source_product_presence?
  source_product_seen     source_product_seen[]
  sources                 sources                   @relation(fields: [sourceId], references: [id])

  @@unique([sourceId, identityType, identityValue])
  @@index([impactItemId])
  @@index([sku])
  @@index([sourceId])
}

model sources {
  id                        String            @id
  name                      String
  url                       String
  type                      SourceType        @default(HTML)
  enabled                   Boolean           @default(true)
  interval                  Int               @default(3600)
  lastRunAt                 DateTime?
  paginationConfig          Json?
  affiliateNetwork          AffiliateNetwork?
  feedHash                  String?
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime
  retailerId                String
  affiliateAccountId        String?
  affiliateAccountName      String?
  affiliateAdvertiserId     String?
  affiliateCampaignId       String?
  affiliateProgramId        String?
  affiliateTrackingTemplate String?
  isDisplayPrimary          Boolean           @default(false)
  sourceKind                SourceKind        @default(DIRECT)
  affiliate_feeds           affiliate_feeds?
  executions                executions[]
  source_products           source_products[]
  retailers                 retailers         @relation(fields: [retailerId], references: [id])

  @@index([retailerId], map: "sources_retailer_id_idx")
}

model subscriptions {
  id         String             @id
  userId     String?
  retailerId String?
  type       SubscriptionType
  status     SubscriptionStatus @default(ACTIVE)
  startDate  DateTime           @default(now())
  endDate    DateTime?
  amount     Decimal            @db.Decimal(10, 2)
  currency   String             @default("USD")
  stripeId   String?            @unique
  retailers  retailers?         @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  users      users?             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model system_settings {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime
  updatedBy   String?
}

model users {
  id                    String                  @id
  email                 String                  @unique
  name                  String?
  image                 String?
  password              String?
  emailVerified         DateTime?
  tier                  UserTier                @default(FREE)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  deletionRequestedAt   DateTime?
  deletionScheduledFor  DateTime?
  status                UserStatus              @default(ACTIVE)
  Account               Account[]
  Session               Session[]
  alerts                alerts[]
  data_subscriptions    data_subscriptions[]
  product_reports       product_reports[]
  subscriptions         subscriptions[]
  watchlist_collections watchlist_collections[]
  watchlist_items       watchlist_items[]
}

model watchlist_collections {
  id              String            @id
  userId          String
  name            String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  users           users             @relation(fields: [userId], references: [id], onDelete: Cascade)
  watchlist_items watchlist_items[]

  @@index([userId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model watchlist_items {
  id                      String                 @id
  userId                  String
  productId               String
  collectionId            String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime
  notificationsEnabled    Boolean                @default(true)
  priceDropEnabled        Boolean                @default(true)
  backInStockEnabled      Boolean                @default(true)
  minDropPercent          Int                    @default(5)
  minDropAmount           Decimal                @default(5.0) @db.Decimal(10, 2)
  stockAlertCooldownHours Int                    @default(24)
  lastStockNotifiedAt     DateTime?
  lastPriceNotifiedAt     DateTime?
  alerts                  alerts[]
  watchlist_collections   watchlist_collections? @relation(fields: [collectionId], references: [id])
  products                products               @relation(fields: [productId], references: [id], onDelete: Cascade)
  users                   users                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([collectionId])
  @@index([productId])
  @@index([userId])
}

enum AdType {
  DISPLAY
  SPONSORED_PRODUCT
  BANNER
}

enum AffiliateFeedRunStatus {
  RUNNING
  SUCCEEDED
  FAILED
}

enum AffiliateFeedRunTrigger {
  SCHEDULED
  MANUAL
  MANUAL_PENDING
  ADMIN_TEST
  RETRY
}

enum AffiliateFeedStatus {
  DRAFT
  ENABLED
  PAUSED
  DISABLED
}

enum AffiliateNetwork {
  IMPACT
  AVANTLINK
  SHAREASALE
  CJ
  RAKUTEN
}

enum AlertRuleType {
  PRICE_DROP
  BACK_IN_STOCK
}

enum AlertType {
  PRICE_DROP
  BACK_IN_STOCK
  NEW_PRODUCT
}

enum BenchmarkConfidence {
  HIGH
  MEDIUM
  NONE
}

enum BenchmarkSource {
  INTERNAL
  EXTERNAL
  MIXED
}

enum BulletType {
  JHP
  HP
  BJHP
  XTP
  HST
  GDHP
  VMAX
  FMJ
  TMJ
  CMJ
  MC
  BALL
  SP
  JSP
  PSP
  RN
  FPRN
  FRANGIBLE
  AP
  TRACER
  BLANK
  WADCUTTER
  SWC
  LSWC
  BUCKSHOT
  BIRDSHOT
  SLUG
  OTHER
}

enum DaaSPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum DataSource {
  MANUFACTURER
  RETAILER_FEED
  PARSED
  MANUAL
  AI_INFERRED
  UNKNOWN
}

enum DealerContactRole {
  PRIMARY
  BILLING
  TECHNICAL
  MARKETING
  OTHER
}

enum DealerPaymentMethod {
  STRIPE
  PURCHASE_ORDER
}

enum DealerStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum DealerSubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum DealerTier {
  FOUNDING
  BASIC
  PRO
  ENTERPRISE
}

enum DealerUserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum FeedAccessType {
  URL
  AUTH_URL
  FTP
  SFTP
  UPLOAD
}

enum FeedCompression {
  NONE
  GZIP
}

enum FeedFormat {
  CSV
}

enum FeedFormatType {
  GENERIC
  AMMOSEEK_V1
  GUNENGINE_V2
  IMPACT
}

enum FeedRunStatus {
  RUNNING
  SUCCESS
  WARNING
  FAILURE
  PENDING
  SKIPPED
}

enum FeedStatus {
  PENDING
  HEALTHY
  WARNING
  FAILED
}

enum FeedTransport {
  FTP
  SFTP
}

enum InsightConfidence {
  HIGH
  MEDIUM
}

enum InsightType {
  OVERPRICED
  UNDERPRICED
  STOCK_OPPORTUNITY
  ATTRIBUTE_GAP
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

enum MappingConfidence {
  HIGH
  MEDIUM
  LOW
  NONE
}

enum PressureRating {
  STANDARD
  PLUS_P
  PLUS_P_PLUS
  NATO
  UNKNOWN
}

enum PriceType {
  REGULAR
  SALE
  CLEARANCE
}

enum ProductIssueType {
  INCORRECT_PRICE
  OUT_OF_STOCK
  INCORRECT_INFO
  BROKEN_LINK
  WRONG_PRODUCT
  SPAM
  OTHER
}

enum ProductSuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  MERGED
}

enum QuarantineStatus {
  QUARANTINED
  RESOLVED
  DISMISSED
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum RetailerTier {
  STANDARD
  PREMIUM
}

enum ShippingType {
  FLAT
  PER_UNIT
  CALCULATED
  FREE
  UNKNOWN
}

enum SourceKind {
  DIRECT
  AFFILIATE_FEED
  OTHER
}

enum SourceProductIdentityType {
  IMPACT_ITEM_ID
  SKU
  URL_HASH
}

enum SourceType {
  HTML
  JS_RENDERED
  RSS
  JSON
  FEED_CSV
  FEED_XML
  FEED_JSON
}

enum StoreType {
  ONLINE_ONLY
  RETAIL_AND_ONLINE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum SubscriptionType {
  USER_PREMIUM
  RETAILER_PREMIUM
}

enum TestRunStatus {
  PASS
  WARN
  FAIL
}

enum UserStatus {
  ACTIVE
  PENDING_DELETION
  DELETED
}

enum UserTier {
  FREE
  PREMIUM
}
